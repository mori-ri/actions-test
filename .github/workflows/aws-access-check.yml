name: AWS access check

on:
  push:
  workflow_dispatch:

env:
  AWS_REGION: ap-northeast-1 # set this to your preferred AWS region, e.g. us-west-1
jobs:
  deploy:
    name: Deploy
    runs-on: ubuntu-latest
    environment: production
    # These permissions are needed to interact with GitHub's OIDC Token endpoint.
    permissions:
      id-token: write
      contents: read
    steps:
      - name: Configure AWS credentials from IAM Role
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ secrets.AWS_ROLE_ARN }}
          aws-region: ${{ env.AWS_REGION }}

      - name: Run AWS Amplify List Jobs
        id: amplify
        run: |
          echo "Development Deployment"
          # branch=${{github.event.pull_request.head.ref}}
          branch="main"
          status=$(aws amplify list-jobs --app-id ${{secrets.AMPLIFY_APP_ID}} --branch-name $branch --query jobSummaries[0].status)
          if [ $? -ne 0 ]; then
            echo "Failed to list jobs $branch"
            exit 1
          fi
          echo "status=$status"
          echo "status=$status" >> $GITHUB_ENV
        shell: bash
